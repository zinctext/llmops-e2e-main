name: LLMOps Build, Scan, and Deploy

on:
  push:
    branches: ["main"] # Trigger on pushes to the main branch
  workflow_dispatch: # Allow manual trigger from the GitHub UI

# Define environment variables based on your Kubernetes and Docker files
env:
  # The image name used in your deployment.yaml is 'darryl1975/fastapi-app'.
  # Set the full repository path, replacing 'darryl1975' with your DOCKERHUB_USERNAME secret.
  IMAGE_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-app
  IMAGE_TAG: ${{ github.sha }} # Use the commit SHA for a unique, immutable tag
  K8S_DEPLOYMENT: gpt-huggingface # Name from deployment.yaml
  K8S_CONTAINER_NAME: gptcontainer # Name of the container inside deployment.yaml
  K8S_NAMESPACE: default # Adjust if you use a different namespace

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read # Required to checkout the code
      packages: write # Required for security features (SARIF report upload)

    steps:
      - name: ‚¨áÔ∏è Checkout Repository Code
        uses: actions/checkout@v4

      # --- 1. BUILD IMAGE & PUSH (Login Prep) ---

      - name: üõ† Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üß± Build and Push Docker image
        # Build and push the image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true # We will push later after scanning
          tags: ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

      # --- 2. SCAN IMAGE using Trivy ---

      - name: üîí Scan Image with Trivy
        uses: aquasecurity/trivy-action@0.21.0
        with:
          image-ref: ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}
          format: "table"
          # Fail the build if any HIGH or CRITICAL severity vulnerabilities are found
          severity: "HIGH,CRITICAL"
          exit-code: "1"
          token: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 3. DEPLOY to Kubernetes Digital Ocean---

      - name: ‚öôÔ∏è Install and Authenticate doctl
        # Uses the DigitalOcean PAT to enable the 'doctl' CLI tool
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: ‚òÅÔ∏è Save DOKS Kubeconfig
        # Runs only if the Trivy scan passed
        if: success()
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DOKS_CLUSTER_NAME }}

      - name: üöÄ Update Kubernetes Deployment
        # Runs only if the Trivy scan passed
        if: success()
        run: |
          # Patch the Deployment with the new image tag
          kubectl set image deployment/${{ env.K8S_DEPLOYMENT }} \
            ${{ env.K8S_CONTAINER_NAME }}=${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }} \
            --namespace ${{ env.K8S_NAMESPACE }}

          # Force a rollout restart and wait for completion
          kubectl rollout restart deployment/${{ env.K8S_DEPLOYMENT }} \
            --namespace ${{ env.K8S_NAMESPACE }}
            
          kubectl rollout status deployment/${{ env.K8S_DEPLOYMENT }} \
            --namespace ${{ env.K8S_NAMESPACE }}

          echo "Deployment successful on DOKS."
